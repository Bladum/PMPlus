# Battle Module

This document is the authoritative design and architecture reference for the XCOM/AlienFall battle systems. It is intended for validation by AI agents and developers to ensure all planned features and classes are implemented as designed. All subsystem documentation is consolidated here.

> **Note:** This README is generated by analyzing every Python file in the module, as per the following instructions:
>
> 1. **Scan All Python Files in the Module**
>    - Exclude files in `test` subfolders and those starting with `test_`.
>    - **Scan all files in the folder, regardless of count.** Do not skip modules with more than 20 files.
> 2. **Purge Existing `readme.md`**
>    - Before writing, clear any previous content.
> 3. **Document Each File and Class**
>    - For each `.py` file, extract class names, docstrings, and method signatures.
>    - For each class, collect a more detailed description:
>      - Summarize the class’s purpose in 2–4 bullet points.
>      - Include responsibilities, integration points, and any unique behaviors or design notes.
> 4. **README Structure**
>    - Overview, System Architecture, Class Purposes and Details, Integration Guide, API Reference.
> 5. **Keep README, Code, and API Documentation in Sync**
>    - Ensure the local `readme.md` describes what the file and its main class are doing. Update whenever code or documentation changes.

## Table of Contents
1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Class Purposes and Details](#class-purposes-and-details)
4. [Integration Guide](#integration-guide)
5. [API Reference](#api-reference)

---

## Overview

The battle module implements the core tactical combat systems for the XCOM/AlienFall game, including battle state management, unit actions, map generation, effects, fog of war, objectives, loot, LOS, pathfinding, map scripting, tile and wall logic, deployment, damage modeling, terrain, tilesets, and reactions. It provides the logic for all tactical encounters, from map setup to turn processing and victory conditions.

## System Architecture

```
Battle Module
├── TBattle (main battle state and logic)
├── TBattleActions (unit action management)
├── TBattleEffect (battle map and unit effects)
├── TBattleFloor (floor tile properties)
├── TBattleFOW (fog of war management)
├── TBattleGenerator (battle map generation)
├── TBattleTile (single tile representation)
├── TBattleWall (wall representation)
├── TBattleRoof (roof layer for tiles)
├── TBattleObject (interactive map objects)
├── BattleLoot (post-battle report and loot calculation)
├── BattleLOS (line-of-sight calculation)
├── BattlePathfinder (A* pathfinding)
├── TBattleScript (map block placement scripting)
├── TBattleScriptStep (script step for map generation)
├── TMapBlock (battle map block)
├── TMapBlockEntry (map block entry for terrain)
├── TDeployment (battle deployment)
├── TDeploymentGroup (deployment group)
├── TDamageModel (damage calculation)
├── TBattleObjective (mission objectives)
├── TReactionFire (reaction fire logic)
├── TTerrain (battle terrain definition)
├── TTilesetManager (tileset and image management)
```

---

## Class Purposes and Details

### TBattle
- Main class for battle state and logic, created by a mission.
- Manages all units, map tiles, items, effects, sides, turns, fog of war, and objectives.
- Responsible for map generation, unit management, turn processing, and objective tracking.

### TBattleActions
- Handles all possible unit actions during battle (movement, crouch, use item, cover, throw, overwatch, suppression, rest).
- Encapsulates the logic for executing and managing unit actions on the battle map, including action validation, execution, and interaction with the game state.

### TBattleEffect
- Represents special effects applied to battle map tiles or units (smoke, fire, panic, sanity, etc.).
- Encapsulates the properties and initialization logic for effects that can influence gameplay, visuals, or unit status on the battle map.

### TBattleFloor
- Represents a floor tile on the battle map, affecting movement, sight, accuracy, and other gameplay mechanics.
- Encapsulates the properties and behaviors of floor tiles, including movement cost, sight cost, cover, armor, sound, light emission, and destruction logic.

### TBattleFOW
- Manages fog of war (FOW) and visibility for all units and tiles on the battle map, for all sides.
- Tracks which tiles are visible, partially visible, or hidden to each side, and updates visibility as units move or perform actions.

### TBattleGenerator
- Generates a battle map from map blocks according to a script.
- Creates battle maps using terrain's map blocks and a map script, following the XCOM/OpenXcom map generation approach.
- Handles block grid setup, map assembly, validation, and export.

### TBattleTile
- Represents a single tile in the battle map, containing floor, wall, roof, objects, unit, and environmental effects.
- Encapsulates all properties and methods for tile state, including passability, sight, light, and destruction logic.

### TBattleWall
- Represents a wall on the battle map, affecting movement, line of sight, fire, and destruction mechanics.
- Encapsulates wall properties such as sight and fire blocking, armor, material, destruction logic, and special effects like explosions or light emission.

### TBattleRoof
- Represents a roof layer on a battle map tile for visual and gameplay purposes (e.g., blocking light, providing cover).
- Placeholder for future attributes and logic.

### TBattleObject
- Represents an interactive object on a battle map tile (pickup, thrown, destroyed, light source, etc.).
- Encapsulates the properties and destruction logic for battlefield objects, including light emission and replacement on destruction.

### BattleLoot
- Handles post-battle report generation, including loot, score, captures, experience, sanity, ammo, medals, and more.
- Provides static methods to generate a summary report after a battle, aggregating all relevant statistics and rewards for the player.

### BattleLOS
- Provides static line-of-sight (LOS) calculation for battle map tiles using Bresenham's algorithm.
- Implements LOS checks for visibility and targeting, considering tile properties such as walls, smoke, fire, and gas.

### BattlePathfinder
- Provides static pathfinding for battle map tiles using the A* algorithm and tile walkability.
- Implements pathfinding logic for units, considering movement cost, walkability, and unit size.

### TBattleScript & TBattleScriptStep
- Defines map assembly logic for battle map generation.
- Represents a script for map block placement, used to generate a battle map from map blocks in a specific way (by group, size, etc).
- Each script consists of steps, each describing how to fill part of the map grid.

### TMapBlock
- Represents a block of the battle map as a 2D array of TBattleTile objects (default 15x15, can be larger).
- Used to generate the tactical battle map. Each block can be placed on the battle map grid.

### TMapBlockEntry
- Represents a map block entry in a terrain definition for battle map generation.
- Describes a block's map name, size, group, selection chance, items, units, and debug visibility.

### TDeployment
- Represents a deployment for a battle, loaded from TOML.
- Contains a list of TDeploymentGroup and civilian info, and generates the list of units for deployment.

### TDeploymentGroup
- Represents a group of similar units in a deployment, loaded from TOML.
- Supports weights for each unit, min/max quantity, and special roles (leader, patrol, guard).

### TDamageModel
- Handles all damage calculations for weapons, explosions, and other sources in battle.
- Responsible for applying damage logic, including armor penetration, critical hits, damage types, and distributing damage to body parts.

### TBattleObjective
- Represents a single mission objective for the battle (eliminate, escape, defend, rescue, etc.).
- Encapsulates the type, parameters, status, and progress of an objective, and provides methods to check completion based on battle state.

### TReactionFire
- Manages the logic for reaction fire in battle.
- Determines when a unit is eligible to perform a reaction shot, resolves the outcome, and integrates with the battle system.

### TTerrain
- Represents a terrain type for battle map generation, including map blocks, scripts, and tileset information.
- Loads TMX map files and creates TMapBlock objects for each entry.

### TTilesetManager
- Loads and manages all tile images from tilesets and individual images for the battle system.
- Provides access to all tile images and masks for the battle map.

---

## Integration Guide

- TBattle is the entry point for tactical combat, integrating with map generation, unit management, and objectives.
- TBattleActions is used by TBattle to process all unit actions each turn.
- TBattleEffect, TBattleFloor, TBattleFOW, TBattleTile, TBattleWall, TBattleObject, TBattleRoof, and BattlePathfinder are used to manage map state, effects, navigation, and environmental logic.
- TBattleGenerator, TBattleScript, TBattleScriptStep, TMapBlock, TMapBlockEntry, TDeployment, and TDeploymentGroup are used to create and populate the initial battle map for each encounter.
- BattleLoot and BattleLOS are used for post-battle reporting and tactical calculations.
- TDamageModel is used for all damage calculations and application during combat.
- TBattleObjective, TReactionFire, TTerrain, and TTilesetManager provide mission, reaction, terrain, and visual management.
- All classes are designed for extensibility and integration with other game systems.

---

## API Reference

- See individual class docstrings and method signatures in the respective Python files for detailed API documentation.
- All classes are designed for use by both AI agents and human developers, with clear separation of state, actions, effects, map logic, deployment, damage, terrain, and visuals.

---

*This README is automatically generated and should be kept in sync with code and documentation changes.*

